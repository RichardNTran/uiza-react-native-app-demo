Object.defineProperty(exports,"__esModule",{value:true});exports.default=undefined;var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _jsxFileName='src/UZPlayer.js';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _react=require('react');var _react2=_interopRequireDefault(_react);var _reactNative=require('react-native');var _expo=require('expo');var _Utils=require('./utils/Utils');var _Utils2=_interopRequireDefault(_Utils);var _API=require('./API');var _API2=_interopRequireDefault(_API);var _Layout=require('./skins/uiza/Layout');var _Layout2=_interopRequireDefault(_Layout);var _PluginManager=require('./plugins/PluginManager');var _PluginManager2=_interopRequireDefault(_PluginManager);var _Event=require('./Event');var _Event2=_interopRequireDefault(_Event);var _State=require('./skins/State');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var UZPlayer=function(_React$Component){_inherits(UZPlayer,_React$Component);function UZPlayer(props){_classCallCheck(this,UZPlayer);if(!!props.debug){_Utils.Logger.enableDebug=true;}var _this=_possibleConstructorReturn(this,(UZPlayer.__proto__||Object.getPrototypeOf(UZPlayer)).call(this,props));_this.initTime=Date.now();var self=_this;var size=_reactNative.Dimensions.get('screen');_this.state={playbackStatus:{},fullsceenState:_State.FullscreenState.EXIT,fullscreenWidth:size.width>size.height?size.width:size.height,fullscreenHeight:size.height<size.width?size.height:size.width};_this.player={VERSION:'1.0.0'};_this.container={};Promise.resolve(_expo.Constants.getWebViewUserAgentAsync()).then(function(res){self.player.userAgent=res;});_this.player.deviceId=_expo.Constants.deviceId;_this.player.sessionId=_expo.Constants.sessionId;_this.player.didJustFinish=false;_this.player.inited=false;_this.player.props=props;_this.player.listener={onError:function onError(evt){_Utils.Logger.debug('onError');if(self.player.props&&self.player.props.listener&&typeof self.player.props.listener.onError==='function'){self.player.props.listener.onError(evt);}},onFullscreenUpdate:function onFullscreenUpdate(evt){_Utils.Logger.debug('onFullscreenUpdate');if(self.player.props&&self.player.props.listener&&typeof self.player.props.listener.onFullscreenChange==='function'){self.player.props.listener.onFullscreenChange(evt);}self.skin.updateState({fullscreen:evt===_State.FullscreenState.ENTER});},onLoad:function onLoad(evt){_Utils.Logger.debug('onLoad');if(self.player.props&&self.player.props.listener&&typeof self.player.props.listener.onLoaded==='function'){self.player.props.listener.onLoaded(evt);}},onLoadStart:function onLoadStart(evt){_Utils.Logger.debug('onLoadStart');if(self.player.props&&self.player.props.listener&&typeof self.player.props.listener.onLoad==='function'){self.player.props.listener.onLoad(evt);}},onPlaybackStatusUpdate:function onPlaybackStatusUpdate(evt){_Utils.Logger.debug('onPlaybackStatusUpdate');self.state.playbackStatus=evt;if(self.state.playbackStatus.didJustFinish){self.player.didJustFinish=true;self.skin.show();}else if(self.state.playbackStatus.isPlaying){self.player.didJustFinish=false;}if(self.player.props&&self.player.props.listener&&typeof self.player.props.listener.onPlaybackChange==='function'){self.player.props.listener.onPlaybackChange(evt);}self.skin.updateState({playbackStatus:self.state.playbackStatus});self.pluginManager.updatePlaybackStatus(self.state.playbackStatus);},onReadyForDisplay:function onReadyForDisplay(evt){_Utils.Logger.debug('onReadyForDisplay');}};_this.pluginManager=new _PluginManager2.default(_this.player.props);return _this;}_createClass(UZPlayer,[{key:'init',value:function init(){var _this2=this;var res;return regeneratorRuntime.async(function init$(_context){while(1){switch(_context.prev=_context.next){case 0:this.entityDetail=null;if(!(this.player.props.stream==='vod')){_context.next=5;break;}_context.next=4;return regeneratorRuntime.awrap(_API2.default.getEntityDetail(this.player.props.api,this.player.props.token,this.player.props.entityId));case 4:this.entityDetail=_context.sent;case 5:_context.next=7;return regeneratorRuntime.awrap(_API2.default.getPlaybackToken(this.player.props.api,this.player.props.appId,this.player.props.entityId));case 7:this.player.playbackToken=_context.sent;this.player.cdnListFull=[];this.player.cdnList=[];res=null;if(!(this.player.props.stream==='vod')){_context.next=17;break;}_context.next=14;return regeneratorRuntime.awrap(_API2.default.getCDNVod(this.player.props.env,this.player.playbackToken,this.player.props.appId,this.player.props.entityId));case 14:res=_context.sent;_context.next=21;break;case 17:if(!(this.player.props.stream==='live')){_context.next=21;break;}_context.next=20;return regeneratorRuntime.awrap(_API2.default.getCDNLive(this.player.props.env,this.player.playbackToken,this.player.props.appId,this.player.props.entityId,this.player.props.streamName,this.player.props.region));case 20:res=_context.sent;case 21:if(!(res&&res.data&&res.data.cdn)){_context.next=26;break;}this.player.cdnListFull=res.data.cdn;this.player.cdnList=[];_context.next=26;return regeneratorRuntime.awrap(Promise.all(res.data.cdn).then(function(cdns){return cdns.map(function(cdn){_this2.player.cdnList.push(cdn.host);});}));case 26:this.pluginManager.init(this.player,{cdnList:this.player.cdnList,entityDetail:this.entityDetail});this.player.inited=true;return _context.abrupt('return',this.player.inited);case 29:case'end':return _context.stop();}}},null,this);}},{key:'toggleFullscreen',value:function toggleFullscreen(){_Utils.Logger.debug('toggleFullscreen: ',this.state.fullsceenState);try{if(this.state.fullsceenState===_State.FullscreenState.ENTER||this.state.fullsceenState===_State.FullscreenState.ENTERING){this.exitFullscreen();this.player.listener.onFullscreenUpdate(_State.FullscreenState.EXIT);}else{this.enterFullscreen();this.player.listener.onFullscreenUpdate(_State.FullscreenState.ENTER);}}catch(e){}}},{key:'enterFullscreen',value:function enterFullscreen(){try{this.state.fullsceenState=_State.FullscreenState.ENTERING;_reactNative.StatusBar.setHidden(true);this.state.fullsceenState=_State.FullscreenState.ENTER;this.setState(function(previousState){return{fullsceenState:_State.FullscreenState.ENTER};});_expo.ScreenOrientation.allow(_expo.ScreenOrientation.Orientation.LANDSCAPE);}catch(e){}}},{key:'exitFullscreen',value:function exitFullscreen(){try{this.state.fullsceenState=_State.FullscreenState.EXITING;_reactNative.StatusBar.setHidden(false);this.state.fullsceenState=_State.FullscreenState.EXIT;this.setState(function(previousState){return{fullsceenState:_State.FullscreenState.EXIT};});_expo.ScreenOrientation.allow(_expo.ScreenOrientation.Orientation.ALL);}catch(e){}}},{key:'togglePlayPause',value:function togglePlayPause(){try{if(this.state.playbackStatus.isPlaying){this.pause();}else{this.play();}}catch(e){}}},{key:'pause',value:function pause(){try{this.player.video.pauseAsync();this.skin.show();}catch(e){}}},{key:'play',value:function play(position){try{if(this.player.didJustFinish){this.player.didJustFinish=false;this.pluginManager.emit('replay');}if(typeof position==='undefined'){this.player.video.playAsync();}else{this.player.video.playFromPositionAsync(position*1000);}this.skin.show();}catch(e){}}},{key:'backward',value:function backward(position){try{if(this.state.playbackStatus){var positionMillis=position*1000;positionMillis=this.state.playbackStatus.positionMillis-positionMillis;if(positionMillis<0){positionMillis=0;}this.player.video.setPositionAsync(positionMillis);}}catch(e){}}},{key:'forward',value:function forward(position){try{if(this.state.playbackStatus){var positionMillis=position*1000;positionMillis=this.state.playbackStatus.positionMillis+positionMillis;if(positionMillis>this.state.playbackStatus.durationMillis-1e4){positionMillis=this.state.playbackStatus.durationMillis-1e4;}this.player.video.setPositionAsync(positionMillis);}}catch(e){}}},{key:'seek',value:function seek(position){var forceSeek=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;try{var positionMillis=position*1000;if(!forceSeek&&positionMillis>this.state.playbackStatus.durationMillis-2000){positionMillis=this.state.playbackStatus.durationMillis-2000;}if(positionMillis<0){positionMillis=0;}this.player.video.setPositionAsync(positionMillis);}catch(e){}}},{key:'render',value:function render(){var _this3=this;var size=_reactNative.Dimensions.get('screen');var height169=Math.floor(size.width*9/16);var view=_react2.default.createElement(_reactNative.View,_extends({},this.props,{style:[styles.container,this.state.fullsceenState==_State.FullscreenState.ENTER?{position:'absolute',zIndex:9999,top:0,left:0,height:this.state.fullscreenHeight,width:this.state.fullscreenWidth}:{height:height169}],ref:function ref(component){_this3.container=component;},__source:{fileName:_jsxFileName,lineNumber:286}}),_react2.default.createElement(_expo.Video,{ref:function ref(component){_this3.player.video=component;},useNativeControls:false,isLooping:false,resizeMode:Expo.Video.RESIZE_MODE_CONTAIN,style:styles.video,onError:this.player.listener.onError,onFullscreenUpdate:this.player.listener.onFullscreenUpdate,onLoad:this.player.listener.onLoad,onLoadStart:this.player.listener.onLoadStart,onPlaybackStatusUpdate:this.player.listener.onPlaybackStatusUpdate,onReadyForDisplay:this.player.listener.onReadyForDisplay,__source:{fileName:_jsxFileName,lineNumber:293}}),_react2.default.createElement(_Layout2.default,{ref:function ref(component){_this3.skin=component;},style:styles.skin,stream:this.player.props.stream,player:this,playbackStatus:this.state.playbackStatus,__source:{fileName:_jsxFileName,lineNumber:310}}));var self=this;Promise.resolve(self.init()).then(function _callee(res){var url;return regeneratorRuntime.async(function _callee$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!self.player.video){_context2.next=16;break;}_context2.prev=1;if(self.player.props&&self.player.props.listener&&typeof self.player.props.listener.onReady==='function'){self.player.props.listener.onReady();}url=null;if(self.player.props.stream==='vod'){url=self.definedLinkPlayVod();}else if(self.player.props.stream==='live'){url=self.definedLinkPlayLive();}_context2.next=7;return regeneratorRuntime.awrap(self.player.video.loadAsync({uri:url}));case 7:_context2.next=9;return regeneratorRuntime.awrap(self.player.video.setStatusAsync({positionMillis:0,isLooping:false,shouldPlay:true}));case 9:_context2.next=16;break;case 11:_context2.prev=11;_context2.t0=_context2['catch'](1);self.skin.updateState({playbackStatus:self.state.playbackStatus});self.skin.hide();_Utils.Logger.debug('error: ',_context2.t0.message);case 16:case'end':return _context2.stop();}}},null,this,[[1,11]]);});this.readyTime=Date.now();this.player.pageLoadTime=this.readyTime-this.initTime;return view;}},{key:'definedLinkPlayVod',value:function definedLinkPlayVod(){try{var prefix='playlist_ts.m3u8';if(_reactNative.Platform.OS==='ios'&&parseInt(_reactNative.Platform.Version,10)>=10){prefix='playlist.m3u8';}else if(_reactNative.Platform.OS==='android'&&parseInt(_reactNative.Platform.Version,10)>=16){prefix='manifest.mpd';}if(this.player.props.playerName==='vod'){prefix='playlist_ts.m3u8';}return'https://'+this.player.cdnList[0]+'/'+this.player.props.appId+'-stream/'+this.player.props.entityId+'/package/'+prefix;}catch(e){self.skin.updateState({playbackStatus:self.state.playbackStatus});self.skin.hide();_Utils.Logger.debug('error: ',e.message);return null;}}},{key:'definedLinkPlayLive',value:function definedLinkPlayLive(){try{var prefix='playlist_ts.m3u8';if(_reactNative.Platform.OS==='ios'&&parseInt(_reactNative.Platform.Version,10)>=10){prefix='playlist.m3u8';}else if(_reactNative.Platform.OS==='android'&&parseInt(_reactNative.Platform.Version,10)>=16){prefix='manifest.mpd';}if(this.player.props.playerName==='vod'){prefix='playlist_ts.m3u8';}return'https://'+this.player.cdnList[0]+'/'+this.player.props.appId+'-live/'+this.player.props.streamName+'/'+prefix;}catch(e){self.skin.updateState({playbackStatus:self.state.playbackStatus});self.skin.hide();_Utils.Logger.debug('error: ',e.message);return null;}}},{key:'didJustFinish',get:function get(){return this.player.didJustFinish;}}],[{key:'Event',get:function get(){return _Event2.default;}}]);return UZPlayer;}(_react2.default.Component);exports.default=UZPlayer;var styles=_reactNative.StyleSheet.create({container:{backgroundColor:'black',width:'100%'},video:{position:'absolute',zIndex:0,top:0,left:0,width:'100%',height:'100%'},skin:{position:'absolute',zIndex:99999,top:0,left:0,width:'100%',height:'100%'}});
//# sourceMappingURL=UZPlayer.js.map